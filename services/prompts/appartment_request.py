from services.context import get_context


async def get_appartment_request_prompt(user_id: int):
    context = await get_context(user_id)

    prompt = f"""
Ти — аналітик діалогів для AI-ріелтора. 
Твоє завдання: проаналізувати повний діалог з користувачем (історія нижче) 
та повернути ключові параметри розмови у форматі JSON.

###
ІСТОРІЯ ДІАЛОГУ:
{context}

###
Твої цілі:

1. Визначити **lead** — чи можна вважати користувача лідуванням:
   - "hot" — готовий давати контакт, хоче перегляд
   - "warm" — назвав бюджет, район, активний інтерес
   - "cold" — задає питання без конкретики, не готовий
   - "no" — повна відмова або тролінг

2. Витягнути **avg_budget** — середній бюджет:
   - якщо названо точну цифру → поверни її
   - якщо діапазон → поверни середнє
   - якщо валюта не вказана → вважай USD
   - якщо нічого не сказав → "unknown"

3. Визначити **reason_decline** — якщо користувач відмовився:
   - "high_price"
   - "bad_location"
   - "not_interested"
   - "just_looking"
   - "spam_fear"
   - "no_decline" (якщо відмови немає)

4. Обчислити **response_time** — середній час відповіді користувача:
   - на основі timestamp’ів у контексті (якщо є)
   - якщо немає часу → "unknown"
   - значення в секундах

###
Формат відповіді (строго JSON):

{{
  "lead": "<hot/warm/cold/no>",
  "avg_budget": "<число або 'unknown'>",
  "reason_decline": "<причина або 'no_decline'>",
  "response_time": "<число або 'unknown'>"
}}

Відповідай ТІЛЬКИ JSON, без пояснень.
"""
    return prompt
